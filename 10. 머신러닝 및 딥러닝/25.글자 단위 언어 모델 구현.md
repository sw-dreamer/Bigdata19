# 글자 단위 언어 모델 구현

```
import torch
import torch.nn as nn
import pandas as pd
import numpy as np
```
```
# 데이터 로딩
# 파일 읽기
with open('./1268-0.txt','r',encoding='utf-8') as fp:
    text = fp.read()

print(text)
```
![image](https://github.com/user-attachments/assets/92f64326-d248-49c6-9db7-b3c2ea052d05)

```
start_idx=text.find('THE MYSTERIOUS ISLAND')
print(start_idx)
```
![image](https://github.com/user-attachments/assets/6a3379cb-5729-4b0f-9147-094ef0510868)

```
end_idx=text.find('End of the Project')
print(end_idx)
```
![image](https://github.com/user-attachments/assets/11134ea9-53fc-4481-9ba2-0479468e07f7)

```
text=text[start_idx:end_idx]
print(text)
```
![image](https://github.com/user-attachments/assets/eac9db17-03f6-40cf-8442-cc811a89c11c)

```
char_set=set(text)
print(char_set)
```
![image](https://github.com/user-attachments/assets/61a406b0-d24e-4e88-b950-348c838d7397)

```
len(char_set)
```
![image](https://github.com/user-attachments/assets/5a5e0fd6-d879-4069-952f-78fecfd30081)

```
print(len(text))
```
![image](https://github.com/user-attachments/assets/b1693be3-0eba-4941-8619-437c98efc3f0)

```
# 인코딩 : 문자 => 숫자, 디코딩 : 숫자 => 문자
# 인코딩
# char_set 정렬
chars_sorted=sorted(char_set)
print(chars_sorted)
```
![image](https://github.com/user-attachments/assets/1caa1427-926f-463f-a40d-594ce7096c90)

```
# 한자씩 인코딩 -> 숫자
char2int={ch:i for i, ch in enumerate(chars_sorted)}
print(char2int)
```
![image](https://github.com/user-attachments/assets/a6f26a63-58f7-4ad5-9d4a-a3717db399e5)
```
# 한 숫자씩 디코딩 => 문자
char_array=np.array(chars_sorted)
print(char_array)
```
![image](https://github.com/user-attachments/assets/0295af6f-2565-463e-b56c-a681916c9244)

```
# text 인코딩
text_encode=np.array(
    [char2int[ch] for ch in text]
    ,dtype=np.int32
)
# 앞에서 10개
print(text[:10])
print(text_encode[:10])
```
![image](https://github.com/user-attachments/assets/fa6ba8e0-2132-47c4-97bd-7c3697e5c9f1)

```
print(text_encode.shape)
```
![image](https://github.com/user-attachments/assets/f7ca81ab-8446-4dc0-9fee-d615b7d0cf72)

```
# 디코딩
print(text_encode[:10])
print(char_array[text_encode[:10]])
```
![image](https://github.com/user-attachments/assets/419d77b9-689e-43cc-b61d-c95ba2437e7a)

```
for ex in text_encode[:10]:
    print('{} -> {}'.format(ex,char_array[ex]))
```
![image](https://github.com/user-attachments/assets/0e86b483-639d-4afd-b657-1a26d6ed29e5)

```
#데이터셋 : 데이터+레이블
from torch.utils.data import Dataset
seq_length=40
chunk_size=seq_length+1
text_chunks = [
    text_encode[i:i+chunk_size] for i in range(len(text_encode)-chunk_size+1)
]
print(text_chunks)
```
![image](https://github.com/user-attachments/assets/85c48aaa-b313-41f2-ba29-5a4aded484ec)

```
len(text_encode)-chunk_size+1
```
![image](https://github.com/user-attachments/assets/ffcff031-3df2-4288-89d8-e19addb67d1f)
```
len(text_encode)
```
![image](https://github.com/user-attachments/assets/b9e4d15f-8d58-4be4-a26e-b25093156c3d)

```
text_chunks[:1]
```
![image](https://github.com/user-attachments/assets/429e3060-7f58-48ba-ac93-5fb02b20b1b1)

```
# 데이터셋 (데이터+렝블) 생성 클래스
class TextDataset(Dataset):
    def __init__(self, text_chunks):
        super().__init__()
        self.text_chunks = text_chunks
        
    def __len__(self):
        return len(self.text_chunks)
    
    def __getitem__(self, index):
        text_chunk = torch.tensor(self.text_chunks[index], dtype=torch.long)
        return text_chunk[:-1], text_chunk[1:]
```
```
seq_dataset=TextDataset(text_chunks=text_chunks)
```
```
for i, (seq, target) in enumerate(seq_dataset):
    print('입력데이터 : ', ''.join(char_array[seq]))  
    print('레이블 : ', ''.join(char_array[target])) 
    if i == 0:
        break
```
![image](https://github.com/user-attachments/assets/0f10a301-8853-46cb-b99f-af24c2883aaa)

```
for i, (seq, target) in enumerate(seq_dataset):
    print('입력데이터 : ',repr(''.join(char_array[seq])))
    print('레이블 : ',repr(''.join(char_array[target])))
    if i==0:
        break
```
![image](https://github.com/user-attachments/assets/20821e3c-1884-4838-a178-ef18d48d5e75)

```
# DataLoader
from torch.utils.data import DataLoader
batch_size=64
torch.manual_seed(1)

seq_dl=DataLoader(
    seq_dataset
    ,batch_size=batch_size
    ,shuffle=True
    ,drop_last=True
)
```
```
import torch.nn as nn

device=torch.device('cuda:0')

class RNN(nn.Module):
    def __init__(self, vocab_size, embed_dim, rnn_hidden_size):
        super().__init__()
        self.embedding = nn.Embedding(vocab_size, embed_dim)
        self.rnn_hidden_size = rnn_hidden_size
        self.rnn = nn.LSTM(embed_dim, rnn_hidden_size,
                           batch_first=True)
        self.fc = nn.Linear(rnn_hidden_size, vocab_size)


    def forward(self, x, hidden, cell):
        out = self.embedding(x).unsqueeze(1)
        out, (hidden, cell) = self.rnn(out, (hidden, cell))
        out = self.fc(out).reshape(out.size(0), -1)
        return out, hidden, cell


    def init_hidden(self, batch_size):
        hidden = torch.zeros(1, batch_size, self.rnn_hidden_size)
        cell = torch.zeros(1, batch_size, self.rnn_hidden_size)
        return hidden.to(device), cell.to(device)
```
```
vocab_size=len(char_array)
embed_size=256
rnn_hidden_size=512
torch.manual_seed(1)
model=RNN(
    vocab_size=vocab_size
    ,embed_dim=embed_size
    ,rnn_hidden_size=rnn_hidden_size
)
#GPU
model=model.to(device=device)
# 신곙망 구성 확인
model
```
![image](https://github.com/user-attachments/assets/7043e415-7f87-4e55-b34d-cb2038d6bf94)

```
loss_fn=nn.CrossEntropyLoss() # 다중 분류 사용
optimizer=torch.optim.Adam(
    model.parameters()
    ,lr=0.005
)
num_epochs=10000
torch.manual_seed(1)

for epoch in range(num_epochs):
    # 처음 hidden, cell 값을 초기화
    hidden,cell=model.init_hidden(batch_size=batch_size)
    seq_batch, target_batch = next(iter(seq_dl)) # 데이터,레이블
    seq_batch=seq_batch.to(device)
    target_batch=target_batch.to(device)
    optimizer.zero_grad()
    loss = 0
    for c_idx in range(seq_length):
        pred, hidden,cell =model(seq_batch[:,c_idx],hidden,cell)
        loss += loss_fn(pred,target_batch[:,c_idx])
    loss.backward()
    optimizer.step()
    loss=loss.item()/seq_length
    if epoch % 500 ==0:
        print(f'에포크 : {epoch}, 손실 : {loss:.4f}')
```
![image](https://github.com/user-attachments/assets/c8178d3f-71a5-4e15-908e-1688eb078e57)
